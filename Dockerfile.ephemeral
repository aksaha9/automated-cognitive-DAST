# Base image: Official ZAP stable
FROM ghcr.io/zaproxy/zaproxy:stable

# Switch to root for installations
USER root

# Install Python/pip if needed (often already present)
RUN apt-get update && \
    apt-get install -y python3 python3-pip && \
    rm -rf /var/lib/apt/lists/*

# Link python -> python3
RUN ln -sf /usr/bin/python3 /usr/bin/python

# Install Python dependencies (bypass externally managed env)
RUN pip3 install fastmcp requests --break-system-packages

# Copy files
COPY zap_mcp_server.py /home/zap/zap_mcp_server.py
COPY entrypoint.sh /home/zap/entrypoint.sh
COPY config/llm_config.json /home/zap/llm_config.json

# Set permissions (no chown needed)
RUN chmod 644 /home/zap/zap_mcp_server.py && \
    chmod 755 /home/zap/entrypoint.sh && \
    mkdir -p /zap/wrk && \
    chown zap:zap /zap/wrk

# Switch to non-root zap user for runtime
USER zap

# Working directory
WORKDIR /home/zap

# Expose port for MCP server mode
EXPOSE 8000

# Entrypoint
ENTRYPOINT ["/home/zap/entrypoint.sh"]